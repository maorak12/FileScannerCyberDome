{% extends "base.html" %}

{% block title %}File Scanner CyberDome - Home{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto text-center">
        <h1 class="display-4 mb-4">
            <i class="fas fa-shield-alt text-primary me-3"></i>
            File Scanner CyberDome
        </h1>
        <p class="lead mb-5">
            Advanced malware detection using YARA rules. Upload executable files to scan for malicious patterns 
            and discover similar files in our database.
        </p>
    </div>
</div>

<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="card">
            <div class="card-body">
                <h3 class="card-title text-center mb-4">
                    <i class="fas fa-upload me-2"></i>Upload File for Scanning
                </h3>
                
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="uploadForm">
                    <div class="file-upload-area mb-4" id="dropZone">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <h4>Drag & Drop your file here</h4>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" name="file" id="fileInput" class="d-none" accept=".exe,.dll,.sys,.scr,.com,.bat,.cmd,.ps1,.vbs,.js">
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose File
                        </button>
                    </div>
                    
                    <div id="fileInfo" class="d-none mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-file me-2"></i>
                            <span id="fileName"></span>
                            <span id="fileSize" class="ms-2"></span>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="uploadBtn" disabled>
                            <i class="fas fa-search me-2"></i>Scan File
                        </button>
                        
                        <!-- Progress Bar (hidden by default) -->
                        <div id="scanProgress" class="mt-3 d-none">
                            <div class="progress" style="height: 25px;">
                                <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%" 
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    <span id="progressText">0%</span>
                                </div>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <span id="currentRule">Initializing...</span>
                            </small>
                            <div class="mt-2">
                                <small class="text-info">
                                    <i class="fas fa-info-circle me-1"></i>
                                    <span id="yaraStats">Preparing YARA rules...</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-lg-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="fas fa-shield-virus fa-3x text-danger mb-3"></i>
                <h5 class="card-title">YARA Rule Scanning</h5>
                <p class="card-text">
                    Comprehensive malware detection using industry-standard YARA rules from Neo23x0 signature-base.
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="fas fa-database fa-3x text-primary mb-3"></i>
                <h5 class="card-title">File Database</h5>
                <p class="card-text">
                    Store and track all scanned files with their YARA rule matches for future reference.
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card text-center h-100">
            <div class="card-body">
                <i class="fas fa-search-plus fa-3x text-success mb-3"></i>
                <h5 class="card-title">Similar File Detection</h5>
                <p class="card-text">
                    Find files with similar YARA rule patterns to identify related malware families.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12 text-center">
        <a href="{{ url_for('list_files') }}" class="btn btn-outline-primary">
            <i class="fas fa-list me-2"></i>View All Scanned Files
        </a>
        <a href="{{ url_for('list_yara_rules') }}" class="btn btn-outline-primary">
            <i class="fas fa-list-alt me-2"></i>View YARA Rules
        </a>
        <a href="{{ url_for('upload_yara_rule') }}" class="btn btn-outline-success ms-2">
            <i class="fas fa-plus me-2"></i>Upload Custom Rule
        </a>
        <a href="{{ url_for('download_yara_rules') }}" class="btn btn-outline-info ms-2">
            <i class="fas fa-download me-2"></i>Download YARA Rules
        </a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadForm = document.getElementById('uploadForm');

    // File input change
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            displayFileInfo(file);
        }
    });

    // Drag and drop functionality
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#764ba2';
        dropZone.style.background = 'rgba(118, 75, 162, 0.1)';
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#667eea';
        dropZone.style.background = 'rgba(102, 126, 234, 0.1)';
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.style.borderColor = '#667eea';
        dropZone.style.background = 'rgba(102, 126, 234, 0.1)';
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            displayFileInfo(files[0]);
        }
    });

    // Click to upload - only trigger if clicking on the drop zone itself, not on buttons inside it
    dropZone.addEventListener('click', function(e) {
        // Don't trigger if clicking on a button or input element
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.closest('button')) {
            return;
        }
        fileInput.click();
    });

    function displayFileInfo(file) {
        fileName.textContent = file.name;
        fileSize.textContent = `(${formatFileSize(file.size)})`;
        fileInfo.classList.remove('d-none');
        uploadBtn.disabled = false;
        
        // Add file icon based on type
        const icon = getFileIcon(file.name);
        fileName.innerHTML = `<i class="${icon} me-2"></i>${file.name}`;
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 MB';
        const mb = bytes / (1024 * 1024);
        return mb.toFixed(2) + ' MB';
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'exe': 'fas fa-file-code',
            'dll': 'fas fa-file-code',
            'sys': 'fas fa-file-code',
            'scr': 'fas fa-file-code',
            'com': 'fas fa-file-code',
            'bat': 'fas fa-file-code',
            'cmd': 'fas fa-file-code',
            'ps1': 'fas fa-file-code',
            'vbs': 'fas fa-file-code',
            'js': 'fas fa-file-code'
        };
        return iconMap[ext] || 'fas fa-file';
    }

    // Form submission
    uploadForm.addEventListener('submit', function(e) {
        if (!fileInput.files[0]) {
            e.preventDefault();
            alert('Please select a file to upload.');
            return;
        }
        
        // Show progress bar
        document.getElementById('scanProgress').classList.remove('d-none');
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Scanning...';
        uploadBtn.disabled = true;
        
        // Start real-time progress tracking
        startRealTimeProgress();
    });
    
    function startRealTimeProgress() {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentRule = document.getElementById('currentRule');
        
        // Initialize progress
        progressBar.style.width = '0%';
        progressBar.setAttribute('aria-valuenow', 0);
        progressText.textContent = '0%';
        currentRule.textContent = 'Preparing scan...';
        updateYaraStats('Initializing YARA rule compilation...');
        
        // Simulate real-time progress updates during the actual scan
        let progress = 0;
        const progressInterval = setInterval(() => {
            // Increment progress gradually to show activity
            progress += Math.random() * 8;
            if (progress >= 95) { // Don't go to 100% until scan is complete
                progress = 95;
            }
            
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = Math.round(progress) + '%';
            
            // Update status messages based on progress
            if (progress < 20) {
                currentRule.textContent = 'Loading YARA rules...';
                updateYaraStats('Counting and loading YARA rule files...');
            } else if (progress < 40) {
                currentRule.textContent = 'Compiling rules...';
                updateYaraStats('Compiling YARA rules for scanning...');
            } else if (progress < 70) {
                currentRule.textContent = 'Scanning file with YARA rules...';
                updateYaraStats('Scanning file against compiled YARA rules...');
            } else if (progress < 95) {
                currentRule.textContent = 'Finalizing scan results...';
                updateYaraStats('Processing scan results and matches...');
            }
        }, 300);
        
        // Store interval ID to clear it later
        window.progressInterval = progressInterval;
    }
    
    // Function to complete progress (called when scan finishes)
    function completeScanProgress() {
        if (window.progressInterval) {
            clearInterval(window.progressInterval);
        }
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentRule = document.getElementById('currentRule');
        
        // Complete the progress bar
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', 100);
        progressText.textContent = '100%';
        currentRule.textContent = 'Scan completed!';
        
        // Change progress bar color to success
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
    }
    
    // Enhanced progress tracking with YARA rule counts
    function updateProgressWithYaraCounts(currentRule, totalRules) {
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const currentRuleText = document.getElementById('currentRule');
        const yaraStats = document.getElementById('yaraStats');
        
        if (totalRules > 0) {
            const progress = Math.round((currentRule / totalRules) * 100);
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = progress + '%';
            currentRuleText.textContent = `Scanning: ${currentRule}/${totalRules} YARA rules checked`;
            yaraStats.textContent = `Progress: ${currentRule} of ${totalRules} rules processed`;
        }
    }
    
    // Function to update YARA statistics
    function updateYaraStats(message) {
        const yaraStats = document.getElementById('yaraStats');
        if (yaraStats) {
            yaraStats.textContent = message;
        }
    }
});
</script>
{% endblock %} 